## 详细设计文档

### 引言

#### 编制目的

编制本详细设计文档的目的是为了提供对系统的详细设计进行全面描述，包括系统的体系结构设计和业务逻辑层的分解。通过详细设计文档，可以为开发人员提供清晰的指导，确保系统的实现符合预期的功能和性能要求。

#### 词汇表

在该文档中，以下术语和缩写词具有以下含义：

- Dao：数据访问对象
- Entity：实体类
- VO：值对象
- BizException：业务异常
- BizError：业务错误
- PaymentStrategy：支付策略
- GSeriesSeatStrategy：G系列座位策略
- KSeriesSeatStrategy：K系列座位策略
- TrainType：列车类型

#### 参考资料

- Spring Framework文档
- Java API文档

### 产品概述

本文档描述了铁路网上售票服务模块的详细设计。

订单服务模块负责处理创建订单、取消订单、支付订单等订单相关的业务逻辑。

路线服务模块负责处理路线相关的业务逻辑，包括添加路线、获取路线列表、获取路线详情、编辑路线和删除路线等操作。

### 体系结构设计概述

订单服务模块采用三层架构，包括表示层、业务逻辑层和数据访问层。表示层负责接收外部请求，业务逻辑层处理具体的业务逻辑，数据访问层负责与数据库进行交互。

### 业务逻辑层的分解

业务逻辑层将订单服务模块拆分为不同的模块，每个模块负责特定的功能。

### 订单服务模块

订单服务模块包含以下模块：

- OrderDao：订单数据访问对象，用于与数据库进行订单数据的持久化操作。
- UserDao：用户数据访问对象，用于与数据库进行用户数据的持久化操作。
- TrainDao：列车数据访问对象，用于与数据库进行列车数据的持久化操作。
- RouteDao：路线数据访问对象，用于与数据库进行路线数据的持久化操作。
- TrainMapper：列车映射器，用于将列车实体转换为列车值对象。
- PaymentStrategy：支付策略接口，定义支付策略的方法。
- WeChatStrategy：微信支付策略，实现支付策略接口，用于进行微信支付。
- AliStrategy：支付宝支付策略，实现支付策略接口，用于进行支付宝支付。

#### 模块结构与职责

- OrderDao：负责与数据库进行订单数据的持久化操作。
- UserDao：负责与数据库进行用户数据的持久化操作。
- TrainDao：负责与数据库进行列车数据的持久化操作。
- RouteDao：负责与数据库进行路线数据的持久化操作。
- TrainMapper：负责将列车实体转换为列车值对象。
- PaymentStrategy：支付策略接口，定义支付策略的方法。
- WeChatStrategy：微信支付策略，实现支付策略接口，用于进行微信支付。
- AliStrategy：支付宝支付策略，实现支付策略接口，用于进行支付宝支付。

#### 接口规范

**接口名（供接口）：createOrder**

语法：

```
 
public Long createOrder(String username, Long trainId, Long fromStationId, Long toStationId, String seatType, Long seatNumber)
```

前置条件：无

后置条件：返回订单ID

**接口名（需接口）：listOrders**

语法：

```
 
public List<OrderVO> listOrders(String username)
```

前置条件：无

后置条件：返回订单VO列表

#### 业务逻辑层的动态模型

详细设计文档中未提供业务逻辑层的动态模型。

#### 业务逻辑层的设计原理

- 根据用户名获取订单列表：根据用户名查询用户ID，然后根据用户ID查询订单列表，按照订单ID降序排序。过滤掉无效的订单，并将有效的订单转换为订单VO对象，最后返回订单VO列表。
- 根据订单ID获取订单详情：根据订单ID查询订单信息，再根据订单中的列车ID查询列车信息和路线信息。根据路线信息和起始站点ID、终点站点ID计算出发时间和到达时间，并将订单信息和计算出的时间等信息转换为订单VO对象，最后返回订单VO。
- 取消订单：根据订单ID查询订单信息，根据订单状态判断是否可以取消订单。如果订单状态是已完成或已取消，抛出业务异常。如果订单状态是已支付或待支付，根据订单中的列车信息和座位信息退还座位，并更新列车信息。如果订单状态是已支付，根据支付策略进行退款和退积分操作，并更新用户积分信息。最后更新订单状态为已取消，并保存订单信息。
- 设置支付策略：根据输入的策略类型选择相应的支付策略，将选定的支付策略赋值给paymentStrategy变量。
- 支付订单：根据订单ID查询订单信息，判断订单状态是否是待支付状态，如果不是，抛出业务异常。根据订单中的用户信息和支付策略进行支付操作，支付成功后更新用户积分信息，将订单状态更新为已支付，并保存订单信息。
- 计算支付金额：根据用户积分和基准价格计算支付金额。根据用户积分和折扣表，计算积分所能享受的折扣，并计算出实际支付金额。
- 计算使用的积分：根据用户积分和折扣表，计算接下来是接口规范的部分，由于字数限制，我将提供接口规范的示例：

### 路线服务模块

路线服务模块包含以下模块：

- RouteDao：路线数据访问对象，用于与数据库进行路线数据的持久化操作。
- RouteMapper：路线映射器，用于将路线实体转换为路线值对象。
- RouteEntity：路线实体类，表示路线的数据结构。
- RouteVO：路线值对象，表示路线的展示结构。
- RouteService：路线服务接口，定义路线相关的操作。

#### 模块结构与职责

- RouteDao：负责与数据库进行路线数据的持久化操作。
- RouteMapper：负责将路线实体转换为路线值对象。
- RouteEntity：表示路线的数据结构，包含路线的名称和站点ID列表。
- RouteVO：表示路线的展示结构，包含路线的ID、名称和站点ID列表。
- RouteService：路线服务接口，定义添加路线、获取路线列表、获取路线详情、编辑路线和删除路线等操作。

#### 接口规范

**接口名（供接口）：addRoute**

语法：

```
 
public void addRoute(String name, List<Long> stationIds)
```

前置条件：无

后置条件：添加路线

**接口名（需接口）：listRoutes**

语法：

```
 
public List<RouteVO> listRoutes()
```

前置条件：无

后置条件：返回路线VO列表

**接口名（需接口）：getRoute**

语法：

```
 
public RouteVO getRoute(Long id)
```

前置条件：无

后置条件：返回路线VO

**接口名（需接口）：editRoute**

语法：

```
 
public void editRoute(Long id, String name, List<Long> stationIds)
```

前置条件：无

后置条件：编辑路线

**接口名（需接口）：delRoute**

语法：

```
 
public void delRoute(Long routeId)
```

前置条件：无

后置条件：删除路线

#### 业务逻辑层的动态模型

详细设计文档中未提供业务逻辑层的动态模型。

#### 业务逻辑层的设计原理

- 添加路线：根据输入的路线名称和站点ID列表，创建路线实体对象，并通过路线数据访问对象进行保存。
- 获取路线列表：通过路线数据访问对象查询所有的路线，并按照名称进行升序排序。然后使用路线映射器将路线实体转换为路线值对象，并将转换后的路线值对象收集到列表中返回。
- 根据ID获取路线详情：通过路线数据访问对象根据路线ID查询路线实体对象，然后使用路线映射器将路线实体转换为路线值对象并返回。
- 编辑路线：通过路线数据访问对象根据路线ID查询路线实体对象，然后更新实体对象的名称和站点ID列表，并通过路线数据访问对象进行保存。
- 删除路线：通过路线数据访问对象根据路线ID删除对应的路线。

### 站点服务模块

站点服务模块包含以下模块：

- StationDao：站点数据访问对象，用于与数据库进行站点数据的持久化操作。
- StationMapper：站点映射器，用于将站点实体转换为站点值对象。
- StationEntity：站点实体类，表示站点的数据结构。
- StationVO：站点值对象，表示站点的展示结构。
- StationService：站点服务接口，定义站点相关的操作。

#### 模块结构与职责

- StationDao：负责与数据库进行站点数据的持久化操作。
- StationMapper：负责将站点实体转换为站点值对象。
- StationEntity：表示站点的数据结构，包含站点的名称。
- StationVO：表示站点的展示结构，包含站点的ID和名称。
- StationService：站点服务接口，定义获取站点信息、获取站点列表、添加站点、编辑站点和删除站点等操作。

#### 接口规范

**接口名（需接口）：getStation**

语法：

```
 
public StationVO getStation(Long stationId)
```

前置条件：无

后置条件：返回站点VO

**接口名（需接口）：listStations**

语法：

```
 
public List<StationVO> listStations()
```

前置条件：无

后置条件：返回站点VO列表

**接口名（供接口）：addStation**

语法：

```
 
public void addStation(String name)
```

前置条件：无

后置条件：添加站点

**接口名（需接口）：editStation**

语法：

```
 
public void editStation(Long id, String name)
```

前置条件：无

后置条件：编辑站点

**接口名（需接口）：delStation**

语法：

```
 
public void delStation(Long stationId)
```

前置条件：无

后置条件：删除站点

#### 业务逻辑层的动态模型

详细设计文档中未提供业务逻辑层的动态模型。

####  业务逻辑层的设计原理

- 根据站点ID获取站点信息：通过站点数据访问对象根据站点ID查询站点实体对象，然后使用站点映射器将站点实体转换为站点值对象并返回。
- 获取所有站点列表：通过站点数据访问对象查询所有的站点，并按照名称进行升序排序。然后使用站点映射器将站点实体转换为站点值对象，并将转换后的站点值对象收集到列表中返回。
- 添加站点：根据输入的站点名称，创建站点实体对象，并通过站点数据访问对象进行保存。在保存之前，检查是否已存在同名的站点，如果存在则抛出业务异常。
- 编辑站点：通过站点数据访问对象根据站点ID查询站点实体对象，然后更新实体对象的名称，并通过站点数据访问对象进行保存。
- 删除站点：通过站点数据访问对象根据站点ID删除对应的站点。

### 列车服务模块

站点服务模块包含以下模块：

- `StationDao`: 站点数据访问对象，用于与数据库进行站点数据的持久化操作。
- `StationMapper`: 站点映射器，用于将站点实体转换为站点值对象。
- `StationEntity`: 站点实体类，表示站点的数据结构。
- `StationVO`: 站点值对象，表示站点的展示结构。
- `StationService`: 站点服务接口，定义站点相关的操作。

#### 模块结构与职责

- `StationDao`: 负责与数据库进行站点数据的持久化操作。
- `StationMapper`: 负责将站点实体转换为站点值对象。
- `StationEntity`: 表示站点的数据结构，包含站点的名称。
- `StationVO`: 表示站点的展示结构，包含站点的ID和名称。
- `StationService`: 站点服务接口，定义获取站点信息、获取站点列表、添加站点、编辑站点和删除站点等操作。

#### 接口规范

```
 
public StationVO getStation(Long stationId);
```

- 前置条件：无
- 后置条件：返回站点VO

```

public List<StationVO> listStations();
```

- 前置条件：无
- 后置条件：返回站点VO列表

```

public void addStation(String name);
```

- 前置条件：无
- 后置条件：添加站点

```
 
public void editStation(Long id, String name);
```

- 前置条件：无
- 后置条件：编辑站点

```
public void delStation(Long stationId);
```

- 前置条件：无
- 后置条件：删除站点

#### 业务逻辑层的动态模型

在给定的代码中，未提供业务逻辑层的动态模型。

#### 业务逻辑层的设计原理

- 根据站点ID获取站点信息：通过站点数据访问对象根据站点ID查询站点实体对象，然后使用站点映射器将站点实体转换为站点值对象并返回。
- 获取所有站点列表：通过站点数据访问对象查询所有的站点，并按照名称进行升序排序。然后使用站点映射器将站点实体转换为站点值对象，并将转换后的站点值对象收集到列表中返回。
- 添加站点：根据输入的站点名称，创建站点实体对象，并通过站点数据访问对象进行保存。在保存之前，检查是否已存在同名的站点，如果存在则抛出业务异常。
- 编辑站点：通过站点数据访问对象根据站点ID查询站点实体对象，然后更新实体对象的名称，并通过站点数据访问对象进行保存。
- 删除站点：通过站点数据访问对象根据站点ID删除对应的站点。

### 站点服务模块

站点服务模块包含以下模块：

- `StationDao`: 站点数据访问对象，用于与数据库进行站点数据的持久化操作。
- `StationMapper`: 站点映射器，用于将站点实体转换为站点值对象。
- `StationEntity`: 站点实体类，表示站点的数据结构。
- `StationVO`: 站点值对象，表示站点的展示结构。
- `StationService`: 站点服务接口，定义站点相关的操作。

#### 模块结构与职责

- `StationDao`: 负责与数据库进行站点数据的持久化操作。包括保存站点、根据站点ID查询站点、根据站点名称查询站点、查询所有站点等操作。
- `StationMapper`: 负责将站点实体转换为站点值对象。包括将站点实体转换为站点值对象的方法。
- `StationEntity`: 表示站点的数据结构，包含站点的名称。
- `StationVO`: 表示站点的展示结构，包含站点的ID和名称。
- `StationService`: 站点服务接口，定义获取站点信息、获取站点列表、添加站点、编辑站点和删除站点等操作。

#### 接口规范

- ```
  getStation(stationId: Long): StationVO
  ```

  - 前置条件：无。
  - 后置条件：返回站点值对象。

- ```
  listStations(): List<StationVO>
  ```

  - 前置条件：无。
  - 后置条件：返回站点值对象列表。

- ```
  addStation(name: String): void
  ```

  - 前置条件：无。
  - 后置条件：添加站点。

- ```
  editStation(id: Long, name: String): void
  ```

  - 前置条件：无。
  - 后置条件：编辑站点。

- ```
  delStation(stationId: Long): void
  ```

  - 前置条件：无。
  - 后置条件：删除站点。

#### 业务逻辑层的动态模型

在给定的代码中，未提供业务逻辑层的动态模型。

#### 业务逻辑层的设计原理

- 根据站点ID获取站点信息：通过站点数据访问对象根据站点ID查询站点实体对象，然后使用站点映射器将站点实体转换为站点值对象并返回。
- 获取所有站点列表：通过站点数据访问对象查询所有的站点，并按照名称进行升序排序。然后使用站点映射器将站点实体转换为站点值对象，并将转换后的站点值对象收集到列表中返回。
- 添加站点：根据输入的站点名称，创建站点实体对象，并通过站点数据访问对象进行保存。在保存之前，检查是否已存在同名的站点，如果存在则抛出业务异常。
- 编辑站点：通过站点数据访问对象根据站点ID查询站点实体对象，然后更新实体对象的名称，并通过站点数据访问对象进行保存。
- 删除站点：通过站点数据访问对象根据站点ID删除对应的站点。